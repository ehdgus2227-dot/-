<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>클라우드 연동 주식 포트폴리오 (v5.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn { @apply px-4 py-2 rounded-lg font-semibold text-white shadow-md transition-all duration-300; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50; }
        .btn-secondary { @apply bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50; }
        .signal-buy { color: #10b981; }
        .signal-sell { color: #ef4444; }
        .signal-hold { color: #6b7280; }
        .loader { border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; position: fixed; top: 50%; left: 50%; margin-top: -20px; margin-left: -20px; z-index: 100; display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 998; }
        /* z-index 수정: 근거 모달이 일반 모달 위에 오도록 */
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); width: 90%; max-width: 400px; text-align: center; z-index: 999; }
        .rationale-modal-content { background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); width: 90%; max-width: 500px; z-index: 1001; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 검색 결과 스타일 */
        #searchResults { display: none; }
        #searchResults div {
            @apply px-4 py-2 cursor-pointer hover:bg-gray-100;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">클라우드 연동 주식 포트폴리오</h1>
            <p class="text-gray-600 mt-2">PC와 모바일에서 실시간 동기화됩니다. (v5.1 - Config 적용)</p>
        </header>

        <!-- API 키 설정 (이전과 동일) -->
        <div class="card p-6 mb-8">
            <!-- ... (API 키 HTML은 변경 없음) ... -->
             <h2 class="text-xl font-semibold mb-4">설정: Alpha Vantage API 키</h2>
            <p class="text-sm text-gray-600 mb-3">
                <a href="https://www.alphavantage.co/support/#api-key" target="_blank" class="text-blue-600 hover:underline">무료 API 키 발급</a>
                (API 키는 PC/모바일 브라우저에 각각 한 번씩 저장해야 합니다.)
            </p>
            <div class="flex gap-4">
                <input type="text" id="apiKeyInput" placeholder="API 키를 입력하세요" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                <button id="saveApiKeyButton" class="btn btn-secondary self-start mt-1">저장</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">
                *참고: '시크릿 모드'나 '프라이빗 브라우징'에서는 API 키가 저장되지 않을 수 있습니다.
            </p>
        </div>

        <!-- 포트폴리오 추가 폼 (이전과 동일) -->
        <div class="card p-6 mb-8">
             <!-- ... (포트폴리오 추가 폼 HTML은 변경 없음) ... -->
             <h2 class="text-xl font-semibold mb-4">새 주식 추가</h2>
             <form id="addStockForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="relative"> <!-- 검색을 위해 relative 추가 -->
                    <label for="stockSymbol" class="block text-sm font-medium text-gray-700">주식 티커 (예: AAPL)</label>
                    <input type="text" id="stockSymbol" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required autocomplete="off">
                    <!-- 티커 검색 결과 -->
                    <div id="searchResults" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto">
                        <!-- 검색 결과가 여기에 표시됩니다. -->
                    </div>
                </div>
                <div>
                    <label for="stockQuantity" class="block text-sm font-medium text-gray-700">보유 수량</label>
                    <input type="number" id="stockQuantity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required min="0">
                </div>
                <div>
                    <label for="purchasePrice" class="block text-sm font-medium text-gray-700">평균 매수 가격 (USD)</label>
                    <input type="number" id="purchasePrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required min="0" step="0.01">
                </div>
                <div class="md:self-end">
                    <button type="submit" class="btn btn-primary w-full md:w-auto">포트폴리오에 추가</button>
                </div>
            </form>
        </div>

        <!-- 내 포트폴리오 -->
        <div>
            <h2 class="text-2xl font-semibold mb-4">내 포트폴리오</h2>
            <div id="portfolioList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 포트폴리오 아이템이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>
    </div>

    <!-- 로딩 스피너 -->
    <div id="loader" class="loader"></div>

    <!-- 커스텀 메시지 모달 -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg mb-4"></p>
            <button id="closeModal" class="btn btn-primary">확인</button>
        </div>
    </div>

    <!-- 신호 근거 상세 모달 (이전과 동일) -->
    <div id="signalRationaleModal" class="modal-overlay">
        <div class="rationale-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="rationaleModalTitle" class="text-xl font-semibold">매매 신호 근거</h3>
                <button id="closeRationaleModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="rationaleModalBody" class="text-left">
                <!-- 근거 내용이 여기에 동적으로 삽입됩니다. -->
            </div>
        </div>
    </div>


    <!-- Firebase SDK 및 앱 로직 -->
    <script type="module">
        // Firebase SDK 임포트 (변경 없음)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            query,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =======================================================================
        // ▼▼▼ 사용자님의 firebaseConfig가 적용되었습니다 ▼▼▼
        // =======================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA9lpUIE3rCTdV51ZEtGH6B5yZr_VVDdT4",
            authDomain: "donghyeon2227.firebaseapp.com",
            projectId: "donghyeon2227",
            storageBucket: "donghyeon2227.firebasestorage.app",
            messagingSenderId: "60070026183",
            appId: "1:60070026183:web:2ae226006cb3b0b1be57e2",
            measurementId: "G-KT8PVSSHPM"
        };
        // =======================================================================

        // --- 전역 변수 및 DOM 요소 ---
        let app, auth, db, userId, portfolioCollectionRef;
        let userApiKey = null;
        const apiKeyStorageKey = 'alphaVantageApiKey';
        let searchDebounceTimer;
        let portfolioRationale = {}; // 종목별 신호 근거 저장용 객체

        const addStockForm = document.getElementById('addStockForm');
        const stockSymbolInput = document.getElementById('stockSymbol');
        const stockQuantityInput = document.getElementById('stockQuantity');
        const purchasePriceInput = document.getElementById('purchasePrice');
        const portfolioList = document.getElementById('portfolioList');
        const loader = document.getElementById('loader');
        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeModal = document.getElementById('closeModal');
        const searchResults = document.getElementById('searchResults');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton');

        // 근거 모달 DOM 요소
        const signalRationaleModal = document.getElementById('signalRationaleModal');
        const closeRationaleModalBtn = document.getElementById('closeRationaleModalBtn');
        const rationaleModalTitle = document.getElementById('rationaleModalTitle');
        const rationaleModalBody = document.getElementById('rationaleModalBody');


        // --- 로더, 모달, API 키 관리 (이전과 동일) ---
        function showLoader() { loader.style.display = 'block'; }
        function hideLoader() { loader.style.display = 'none'; }
        function showModal(message) {
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        }
        closeModal.addEventListener('click', () => {
            messageModal.style.display = 'none';
        });

        // 근거 모달 여닫기 함수 (이전과 동일)
        function showRationaleModal(rationale, symbol) {
            rationaleModalTitle.textContent = `${symbol} 매매 신호 근거`;
            
            // 모달 내용(테이블) 생성
            let rationaleHtml = `
                <p class="text-center mb-4 text-lg">
                    최종 신호: <span class="font-bold ${rationale.signalClass}">${rationale.finalSignal}</span>
                    <span class="text-sm"> (매수: ${rationale.buyCount} / 매도: ${rationale.sellCount})</span>
                </p>
                <table class="w-full text-sm text-left text-gray-700">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="px-4 py-3">기술적 지표</th>
                            <th scope="col" class="px-4 py-3">현재 상태 (값)</th>
                            <th scope="col" class="px-4 py-3">판단</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b">
                            <td class="px-4 py-3 font-medium">볼린저 밴드 (20, 2)</td>
                            <td class="px-4 py-3">${rationale.bb.status} (${rationale.bb.value})</td>
                            <td class="px-4 py-3 font-bold ${rationale.bb.signalClass}">${rationale.bb.signal}</td>
                        </tr>
                        <tr class="border-b">
                            <td class="px-4 py-3 font-medium">RSI (14)</td>
                            <td class="px-4 py-3">${rationale.rsi.status} (${rationale.rsi.value})</td>
                            <td class="px-4 py-3 font-bold ${rationale.rsi.signalClass}">${rationale.rsi.signal}</td>
                        </tr>
                        <tr class="border-b">
                            <td class="px-4 py-3 font-medium">MACD (12, 26, 9)</td>
                            <td class="px-4 py-3">${rationale.macd.status} (${rationale.macd.value})</td>
                            <td class="px-4 py-3 font-bold ${rationale.macd.signalClass}">${rationale.macd.signal}</td>
                        </tr>
                    </tbody>
                </table>
                <p class="text-xs text-gray-500 mt-4">*주의: 본 신호는 일봉 기준 3가지 보조지표의 기계적 계산 결과이며, 투자 조언이 아닙니다. 실제 매매는 시장 상황, 뉴스, 재무제표 등 복합적인 요소를 고려해야 합니다.</p>
            `;
            
            rationaleModalBody.innerHTML = rationaleHtml;
            signalRationaleModal.style.display = 'flex';
        }
        closeRationaleModalBtn.addEventListener('click', () => {
            signalRationaleModal.style.display = 'none';
        });

        // (API 키 저장/로드, API 호출 함수들은 변경 없음)
        function saveApiKey() { /* ... (이전과 동일) ... */ 
            try {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem(apiKeyStorageKey, key); // 이 시점에서 오류가 날 수 있음 (예: 시크릿 모드)
                    userApiKey = key; // Updates the global variable
                    showModal("API 키가 저장되었습니다.");
                } else {
                    showModal("API 키를 입력하세요.");
                }
            } catch (error) {
                console.error("API 키 저장 실패:", error);
                showModal("API 키를 저장하지 못했습니다. 브라우저가 시크릿 모드는 아닌지 확인해주세요.");
            }
        }
        function loadApiKey() { /* ... (이전과 동일) ... */ 
            try {
                const key = localStorage.getItem(apiKeyStorageKey);
                if (key) {
                    userApiKey = key;
                    apiKeyInput.value = key; // Puts the key back in the input box
                }
            } catch (error) {
                console.warn("API 키 로드 실패:", error);
                // 로드 실패는 치명적이지 않으므로 모달을 띄우지 않음
            }
        }
        async function fetchTickerSearch(query) { /* ... (이전과 동일) ... */ 
            if (!userApiKey) { console.warn("API 키가 없어 티커 검색을 건너뜁니다."); return null; }
            if (query.length < 1) return null;
            const url = `https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${query}&apikey=${userApiKey}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('API 응답 실패');
                const data = await response.json();
                if (data["Error Message"] || data["Information"]) { console.warn("티커 검색 API 오류 또는 한도 도달:", data["Error Message"] || data["Information"]); return null; }
                return data.bestMatches || [];
            } catch (error) {
                console.error("티커 검색 실패:", error);
                return null;
            }
        }
        async function fetchRealStockData(symbol) { /* ... (이전과 동일) ... */ 
             if (!userApiKey) { showModal("Alpha Vantage API 키를 먼저 '설정'에서 입력하고 저장해주세요."); return null; }
            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&outputsize=compact&apikey=${userApiKey}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API 요청 실패: ${response.statusText}`);
                const data = await response.json();
                if (data["Error Message"]) throw new Error(`API 오류: ${data["Error Message"]}`);
                if (data["Information"]) throw new Error("API 호출 한도 도달. 잠시 후 시도하세요.");
                const timeSeries = data["Time Series (Daily)"];
                if (!timeSeries) throw new Error("유효한 시계열 데이터가 없습니다.");
                const latestDate = Object.keys(timeSeries)[0];
                const latestClosePrice = parseFloat(timeSeries[latestDate]["4. close"]);
                const historicalPrices = Object.keys(timeSeries).map(date => parseFloat(timeSeries[date]["4. close"])).reverse();
                return { symbol, currentPrice: latestClosePrice, historicalPrices };
            } catch (error) {
                console.error(`[${symbol}] 데이터 오류:`, error);
                showModal(`[${symbol}] 데이터 오류: ${error.message}`);
                return { error: true, symbol, message: error.message };
            }
        }


        // --- 기술적 지표 계산 함수 (이전과 동일) ---
        function calculateSMA(data, period) { /* ... (이전과 동일) ... */ if (data.length < period) return null; return data.slice(-period).reduce((a, b) => a + b, 0) / period; }
        function calculateEMA(data, period) { /* ... (이전과 동일) ... */ if (data.length < period) return []; const k = 2 / (period + 1); let emaData = [data.slice(0, period).reduce((a, b) => a + b, 0) / period]; for(let i = period; i < data.length; i++) { emaData.push((data[i] * k) + (emaData[emaData.length - 1] * (1 - k))); } return emaData; }
        function calculateStdDev(data, period) { /* ... (이전과 동일) ... */ const slice = data.slice(-period); if (slice.length < period) return null; const sma = calculateSMA(slice, period); if (sma === null) return null; return Math.sqrt(slice.reduce((a, b) => a + Math.pow(b - sma, 2), 0) / period); }
        function calculateBollingerBands(data, period = 20, stdDevMultiplier = 2) { /* ... (이전과 동일) ... */ if (data.length < period) return { middle: null, upper: null, lower: null }; const sma = calculateSMA(data, period); const stdDev = calculateStdDev(data, period); if (sma === null || stdDev === null) return { middle: null, upper: null, lower: null }; return { middle: sma, upper: sma + (stdDev * stdDevMultiplier), lower: sma - (stdDev * stdDevMultiplier) }; }
        function calculateRSI(data, period = 14) { /* ... (이전과 동일) ... */ if (data.length <= period) return null; let gains = 0; let losses = 0; for (let i = data.length - period; i < data.length; i++) { const change = data[i] - data[i-1]; if (change > 0) { gains += change; } else { losses -= change; } } let avgGain = gains / period; let avgLoss = losses / period; if (avgLoss === 0) return 100; const rs = avgGain / avgLoss; return 100 - (100 / (1 + rs)); }
        function calculateMACD(data, shortPeriod = 12, longPeriod = 26, signalPeriod = 9) { /* ... (이전과 동일) ... */ if (data.length < longPeriod) return { macd: null, signal: null, histogram: null }; const emaShortAll = calculateEMA(data, shortPeriod); const emaLongAll = calculateEMA(data, longPeriod); const macdLineData = emaShortAll.slice(emaShortAll.length - emaLongAll.length).map((val, idx) => val - emaLongAll[idx]); if (macdLineData.length < signalPeriod) return { macd: null, signal: null, histogram: null }; const signalLineData = calculateEMA(macdLineData, signalPeriod); const latestMacd = macdLineData[macdLineData.length - 1]; const latestSignal = signalLineData[signalLineData.length - 1]; return { macd: latestMacd, signal: latestSignal, histogram: latestMacd - latestSignal }; }
        
        // --- getTradingSignal 함수 (이전과 동일) ---
        function getTradingSignal(stockData) {
            const prices = stockData.historicalPrices;
            const currentPrice = stockData.currentPrice;

            let rationale = {
                bb: { status: '데이터 부족', value: 'N/A', signal: '보유', signalClass: 'signal-hold' },
                rsi: { status: '데이터 부족', value: 'N/A', signal: '보유', signalClass: 'signal-hold' },
                macd: { status: '데이터 부족', value: 'N/A', signal: '보유', signalClass: 'signal-hold' },
                buyCount: 0,
                sellCount: 0,
                finalSignal: '보유 (Hold)',
                signalClass: 'signal-hold',
                recommendation: { type: '관망', price: null }
            };

            if (prices.length < 26) { // 최소 MACD 계산 가능 일수
                return rationale; // 데이터 부족 상태의 기본 'rationale' 반환
            }

            let recommendedAction = { type: 'N/A', price: null };
            
            // 1. 볼린저 밴드
            const bb = calculateBollingerBands(prices);
            if (bb.lower && currentPrice < bb.lower) {
                rationale.buyCount++;
                rationale.bb = { status: '가격이 하단 밴드 이탈', value: `< $${bb.lower.toFixed(2)}`, signal: '매수', signalClass: 'signal-buy' };
                recommendedAction = { type: '매수 추천 (BB 하단)', price: bb.lower.toFixed(2) };
            } else if (bb.upper && currentPrice > bb.upper) {
                rationale.sellCount++;
                rationale.bb = { status: '가격이 상단 밴드 이탈', value: `> $${bb.upper.toFixed(2)}`, signal: '매도', signalClass: 'signal-sell' };
                recommendedAction = { type: '매도 추천 (BB 상단)', price: bb.upper.toFixed(2) };
            } else if (bb.middle) {
                rationale.bb = { status: '밴드 내 (중심선)', value: `~ $${bb.middle.toFixed(2)}`, signal: '보유', signalClass: 'signal-hold' };
            } else {
                 rationale.bb = { status: '계산 불가', value: `N/A`, signal: '보유', signalClass: 'signal-hold' };
            }

            // 2. RSI
            const rsi = calculateRSI(prices);
            if (rsi !== null && rsi < 30) {
                rationale.buyCount++;
                rationale.rsi = { status: '과매도 구간', value: `RSI ${rsi.toFixed(2)}`, signal: '매수', signalClass: 'signal-buy' };
                if (recommendedAction.type === 'N/A') recommendedAction = { type: '매수 고려 (RSI 과매도)', price: currentPrice.toFixed(2) };
            } else if (rsi !== null && rsi > 70) {
                rationale.sellCount++;
                rationale.rsi = { status: '과매수 구간', value: `RSI ${rsi.toFixed(2)}`, signal: '매도', signalClass: 'signal-sell' };
                if (recommendedAction.type === 'N/A') recommendedAction = { type: '매도 고려 (RSI 과매수)', price: currentPrice.toFixed(2) };
            } else if (rsi !== null) {
                rationale.rsi = { status: '중립 구간', value: `RSI ${rsi.toFixed(2)}`, signal: '보유', signalClass: 'signal-hold' };
            } else {
                 rationale.rsi = { status: '계산 불가', value: 'N/A', signal: '보유', signalClass: 'signal-hold' };
            }

            // 3. MACD (히스토그램 기준)
            const macd = calculateMACD(prices);
            if (macd.histogram !== null && macd.histogram > 0) {
                rationale.buyCount++;
                rationale.macd = { status: '히스토그램 양전환 (상승 추세)', value: `Hist ${macd.histogram.toFixed(2)}`, signal: '매수', signalClass: 'signal-buy' };
            } else if (macd.histogram !== null && macd.histogram < 0) {
                rationale.sellCount++;
                rationale.macd = { status: '히스토그램 음전환 (하락 추세)', value: `Hist ${macd.histogram.toFixed(2)}`, signal: '매도', signalClass: 'signal-sell' };
            } else if (macd.histogram !== null) {
                 rationale.macd = { status: '0선 수렴', value: 'Hist 0.00', signal: '보유', signalClass: 'signal-hold' };
            } else {
                 rationale.macd = { status: '계산 불가', value: 'N/A', signal: '보유', signalClass: 'signal-hold' };
            }

            // 최종 신호 결정
            if (rationale.buyCount > rationale.sellCount && rationale.buyCount >= 1) {
                rationale.finalSignal = '매수 (Buy)';
                rationale.signalClass = 'signal-buy';
            } else if (rationale.sellCount > rationale.buyCount && rationale.sellCount >= 1) {
                rationale.finalSignal = '매도 (Sell)';
                rationale.signalClass = 'signal-sell';
            } else {
                rationale.finalSignal = '보유 (Hold)';
                rationale.signalClass = 'signal-hold';
            }
            
            if (recommendedAction.type === 'N/A') {
                rationale.recommendation = { type: '관망', price: null };
            } else {
                rationale.recommendation = recommendedAction;
            }

            return rationale;
        }


        // --- renderPortfolio 함수 (이전과 동일) ---
        async function renderPortfolio(doc) {
            const stock = doc.data();
            const stockId = doc.id;
            
            showLoader(); 
            const stockData = await fetchRealStockData(stock.symbol);
            hideLoader(); 

            let cardHtml;

            if (!stockData || stockData.error) {
                // (오류 시 카드 HTML은 동일)
                cardHtml = `
                    <button class="absolute top-3 right-3 text-gray-400 hover:text-red-500 font-bold remove-stock" data-id="${stockId}">X</button>
                    <h3 class="text-xl font-bold text-red-700">${stock.symbol.toUpperCase()}</h3>
                    <p class="text-red-600 mt-4">데이터를 불러오는데 실패했습니다.</p>
                    <p class="text-sm text-gray-600">${stockData ? stockData.message : 'API 키를 확인하세요.'}</p>
                `;
            } else {
                const tradingSignal = getTradingSignal(stockData);
                // 종목의 신호 근거를 전역 객체에 저장
                portfolioRationale[stockId] = tradingSignal;
                
                const currentPrice = stockData.currentPrice;
                // (계산 로직은 동일)
                const totalValue = currentPrice * stock.quantity;
                const purchaseValue = stock.purchasePrice * stock.quantity;
                const gainLoss = totalValue - purchaseValue;
                const gainLossPercent = (purchaseValue === 0) ? 0 : (gainLoss / purchaseValue) * 100;
                const gainLossClass = gainLoss >= 0 ? 'text-green-600' : 'text-red-600';

                cardHtml = `
                    <button class="absolute top-3 right-3 text-gray-400 hover:text-red-500 font-bold remove-stock" data-id="${stockId}">X</button>
                    <h3 class="text-xl font-bold text-blue-700">${stock.symbol.toUpperCase()}</h3>
                    <p class="text-sm text-gray-500 mb-4">수량: ${stock.quantity}</p>
                    <!-- ... (평가손익 등 이전과 동일) ... -->
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between"><span class="text-gray-600">평균 매수가:</span><span class="font-medium">$${stock.purchasePrice.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">현재가 (전일 종가):</span><span class="font-medium">$${currentPrice.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span class="font-semibold text-gray-700">평가손익:</span><span class="font-semibold ${gainLossClass}">$${gainLoss.toFixed(2)} (${gainLossPercent.toFixed(2)}%)</span></div>
                        <div class="flex justify-between"><span class="font-semibold text-gray-700">총 평가금액:</span><span class="font-semibold">$${totalValue.toFixed(2)}</span></div>
                    </div>
                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">매매 신호 (일봉):</span>
                            
                            <!-- 근거 보기 버튼 -->
                            <div classs="text-right">
                                <span class="font-bold text-lg ${tradingSignal.signalClass}">${tradingSignal.finalSignal}</span>
                                <button class="rationale-button ml-1 text-xs text-blue-600 hover:underline focus:outline-none" data-stock-id="${stockId}">(근거 보기)</button>
                            </div>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">추천 행동:</span>
                            <span class="font-medium text-right">${tradingSignal.recommendation.type}</span>
                        </div>
                         <div class="flex justify-between text-sm">
                            <span class="text-gray-600">추천 가격 (참고):</span>
                            <span class="font-medium">${tradingSignal.recommendation.price ? '$' + tradingSignal.recommendation.price : 'N/A'}</span>
                        </div>
                    </div>
                `;
            }

            let card = portfolioList.querySelector(`[data-id="${stockId}"]`);
            if (!card) {
                card = document.createElement('div');
                card.className = 'card p-5 relative';
                card.setAttribute('data-id', stockId);
                portfolioList.appendChild(card);
            }
            card.innerHTML = cardHtml;
            
            // 삭제 버튼 리스너
            card.querySelector('.remove-stock').addEventListener('click', (e) => {
                e.stopPropagation();
                removeStock(e.target.dataset.id);
            });

            // 근거 보기 버튼 리스너 (오류 카드가 아닐 때만 추가)
            if (stockData && !stockData.error) {
                card.querySelector('.rationale-button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const stockId = e.target.dataset.stockId;
                    const rationale = portfolioRationale[stockId];
                    if (rationale) {
                        showRationaleModal(rationale, stock.symbol.toUpperCase());
                    }
                });
            }
        }

        // --- Firestore 상호작용 (이전과 동일) ---
        async function addStock(e) { /* ... (이전과 동일) ... */ 
            e.preventDefault();
            if (!userId) { showModal("데이터베이스에 연결되지 않았습니다. 잠시 후 다시 시도하세요."); return; }
            if (!userApiKey) { showModal("API 키를 먼저 설정하고 저장해주세요."); return; }
            const symbol = stockSymbolInput.value.trim().toUpperCase();
            const quantity = parseFloat(stockQuantityInput.value);
            const price = parseFloat(purchasePriceInput.value);
            if (!symbol || isNaN(quantity) || isNaN(price) || quantity < 0 || price < 0) { showModal("유효한 주식 티커, 수량, 가격을 입력하세요."); return; }
            
            showLoader();
            try {
                // API 호출로 티커 유효성 검사
                const testData = await fetchRealStockData(symbol);
                if (!testData || testData.error) { 
                    hideLoader(); 
                    // fetchRealStockData 내부에서 이미 오류 모달을 띄웁니다.
                    return; 
                }

                // Firestore에 문서 추가
                const docRef = await addDoc(portfolioCollectionRef, {
                    symbol: symbol,
                    quantity: quantity,
                    purchasePrice: price,
                    userId: userId 
                });
                console.log("주식 추가 성공, Doc ID:", docRef.id);
                
                // 폼 초기화
                stockSymbolInput.value = '';
                stockQuantityInput.value = '';
                purchasePriceInput.value = '';

            } catch (error) {
                console.error("주식 추가 오류 (addStock 함수):", error);
                showModal(`주식 추가 중 오류가 발생했습니다: ${error.message}`);
            } finally {
                hideLoader();
            }
        }
        async function removeStock(id) { /* ... (이전과 동일) ... */ 
            if (!window.confirm("정말로 이 주식을 포트폴리오에서 삭제하시겠습니까?")) return;
            showLoader();
            try {
                const docRef = doc(db, portfolioCollectionRef.path, id);
                await deleteDoc(docRef);
                showModal("주식이 삭제되었습니다.");
            } catch (error) {
                console.error("주식 삭제 오류:", error);
                showModal("주식 삭제 중 오류가 발생했습니다.");
            } finally {
                hideLoader();
            }
        }
        
        // --- 티커 검색 핸들러 (이전과 동일) ---
        async function handleTickerSearch(e) { /* ... (이전과 동일) ... */ 
            const query = e.target.value;
            if (query.length < 1) { searchResults.style.display = 'none'; return; }
            const matches = await fetchTickerSearch(query);
            searchResults.innerHTML = ''; 
            if (!matches || matches.length === 0) {
                searchResults.innerHTML = `<div class="text-gray-500 italic">검색 결과가 없습니다.</div>`;
                searchResults.style.display = 'block';
                return;
            }
            matches.forEach(match => {
                const symbol = match["1. symbol"];
                const name = match["2. name"];
                const region = match["4. region"];
                const resultEl = document.createElement('div');
                resultEl.innerHTML = `<span class="font-bold">${symbol}</span><span class="text-sm text-gray-600 ml-2">(${name}) - ${region}</span>`;
                resultEl.addEventListener('click', () => {
                    stockSymbolInput.value = symbol; 
                    searchResults.style.display = 'none'; 
                });
                searchResults.appendChild(resultEl);
            });
            searchResults.style.display = 'block';
        }
        function debounce(func, delay) { /* ... (이전과 동일) ... */ 
            return function(...args) {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // --- 앱 시작 (이전과 동일) ---
        async function initializeAppLogic() { /* ... (이전과 동일) ... */ 
            // API 키 로직은 DOMContentLoaded에서 이미 처리됨
            
            // firebaseConfig 유효성 검사
            if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId) {
                console.error("Firebase 설정이 누락되었습니다.", firebaseConfig);
                showModal("Firebase 설정이 누락되었습니다. 코드의 firebaseConfig 변수를 확인하세요.");
                hideLoader(); // 로더가 있다면 숨김
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug'); // Firestore 로그 레벨 설정

                showLoader();

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("익명 인증 성공, UserId:", userId);
                        
                        // users/{userId}/portfolio 경로 설정
                        const collectionPath = `users/${userId}/portfolio`;
                        portfolioCollectionRef = collection(db, collectionPath);
                        
                        // 실시간 스냅샷 리스너 설정
                        const q = query(portfolioCollectionRef);
                        onSnapshot(q, (snapshot) => {
                            hideLoader();
                            if (snapshot.empty) {
                                portfolioList.innerHTML = '<p class="text-gray-500 col-span-full">포트폴리오가 비어있습니다. 새 주식을 추가하세요.</p>';
                            }
                            
                            // 문서 변경 사항 처리
                            snapshot.docChanges().forEach((change) => {
                                const doc = change.doc;
                                if (change.type === "added" || change.type === "modified") {
                                    // console.log("데이터 변경 감지 (추가/수정):", doc.data());
                                    renderPortfolio(doc);
                                }
                                if (change.type === "removed") {
                                    // console.log("데이터 변경 감지 (삭제):", doc.id);
                                    const cardToRemove = portfolioList.querySelector(`[data-id="${doc.id}"]`);
                                    if (cardToRemove) cardToRemove.remove();
                                }
                            });
                        }, (error) => {
                            console.error("onSnapshot 오류:", error);
                            showModal(`포트폴리오 로딩 중 오류 발생: ${error.message}`);
                            hideLoader();
                        });

                        // 폼 제출 리스너 (인증 성공 후 한 번만 등록)
                        // 이전에 등록된 리스너가 있다면 제거 (중복 방지)
                        addStockForm.removeEventListener('submit', addStock); 
                        addStockForm.addEventListener('submit', addStock);

                    } else {
                        // 사용자가 로그인되어 있지 않으면 익명 로그인 시도
                        console.log("익명 로그인 시도 중...");
                        await signInAnonymously(auth);
                    }
                }, (error) => {
                    console.error("Auth 상태 변경 오류:", error);
                    showModal(`인증 중 오류가 발생했습니다: ${error.message}`);
                    hideLoader();
                });
            } catch (error) {
                console.error("Firebase 초기화 오류:", error);
                // firebaseConfig를 문자열로 변환하여 로그에 포함 (민감 정보 주의)
                // console.error("사용된 Config:", JSON.stringify(firebaseConfig));
                showModal(`Firebase 초기화 오류: ${error.message}. firebaseConfig 값을 다시 확인하세요.`);
                hideLoader();
            }
        }

        // --- DOMContentLoaded 리스너 (이전과 동일) ---
        document.addEventListener('DOMContentLoaded', () => { /* ... (이전과 동일) ... */ 
            
            // API 키 관련 로직을 Firebase 초기화와 분리하여 먼저 실행합니다.
            loadApiKey(); 
            saveApiKeyButton.addEventListener('click', saveApiKey);

            // 이제 Firebase 및 나머지 앱 로직 초기화 시도
            initializeAppLogic();
            
            // 티커 검색 이벤트 리스너 (디바운스 적용)
            stockSymbolInput.addEventListener('input', debounce(handleTickerSearch, 300));

            // 검색창 바깥을 클릭하면 닫기
            document.addEventListener('click', (e) => {
                if (!stockSymbolInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        });

    </script>
</body>
</html>
